<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLUB_2000_AUTH</title>
    <style>
        body { background: #008080; font-family: "Tahoma", sans-serif; margin: 0; padding: 10px; font-size: 12px; }
        .win { background: #c0c0c0; border: 2px solid; border-color: #fff #808080 #808080 #fff; width: 100%; max-width: 360px; margin: 0 auto; }
        .title { background: linear-gradient(to right, #000080, #1084d0); color: #fff; padding: 3px 5px; font-weight: bold; }
        #box { background: #fff; height: 250px; overflow-y: scroll; border: 2px inset #fff; margin: 5px; padding: 5px; }
        .msg { border-bottom: 1px dotted #808080; margin-bottom: 5px; padding: 2px; }
        .priv { background: #ffe0ff; border-left: 3px solid #800080; } /* –°—Ç–∏–ª—å –õ–° */
        .u { color: #0000ff; font-weight: bold; cursor: pointer; text-decoration: underline; }
        .input-bar { background: #c0c0c0; padding: 8px; border-top: 1px solid #808080; text-align: center; }
        input { font-size: 12px; border: 2px inset #fff; padding: 2px; margin: 2px; }
        .btn { background: #c0c0c0; border: 2px solid; border-color: #fff #808080 #808080 #fff; cursor: pointer; padding: 2px 5px; font-weight: bold; }
        #auth-screen { padding: 20px; text-align: center; }
    </style>
</head>
<body>

<div id="login-zone" class="win">
    <div class="title">–í–•–û–î –í –ö–õ–£–ë</div>
    <div id="auth-screen">
        –ù–∏–∫: <br><input type="text" id="user" style="width:120px"><br>
        –ü–∞—Ä–æ–ª—å: <br><input type="password" id="pass" style="width:120px"><br><br>
        <button class="btn" onclick="login()">–í–û–ô–¢–ò / –°–û–ó–î–ê–¢–¨</button>
    </div>
</div>

<div id="chat-zone" class="win" style="display:none;">
    <div class="title">üåº –ö–õ–£–ë 2000: <span id="my-name"></span></div>
    <div id="box">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div class="input-bar">
        <input type="text" id="msg" style="width:70%" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ /w –Ω–∏–∫...">
        <button class="btn" onclick="send()">OK</button>
        <div style="margin-top:5px;">
            <button class="btn" onclick="load()">–û–ë–ù–û–í–ò–¢–¨</button>
            <button class="btn" onclick="location.reload()">–í–´–•–û–î</button>
        </div>
    </div>
</div>

<script>
    var dbUrl = "https://ple7-edit-v1-default-rtdb.europe-west1.firebasedatabase.app/";
    var currentUser = "";
    var currentPass = "";

    // 1. –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø
    function login() {
        var u = document.getElementById('user').value.trim();
        var p = document.getElementById('pass').value.trim();
        if(u.length < 2 || p.length < 2) { alert("–ù–∏–∫ –∏ –ø–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ!"); return; }

        var xhr = new XMLHttpRequest();
        xhr.open("GET", dbUrl + "profiles/" + u + ".json", true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4) {
                var profile = JSON.parse(xhr.responseText);
                if (!profile) {
                    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ —é–∑–µ—Ä–∞
                    if(confirm("–ù–∏–∫ —Å–≤–æ–±–æ–¥–µ–Ω. –°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç?")) {
                        saveAccount(u, p);
                    }
                } else {
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
                    if (profile.pw === p) {
                        startChat(u, p);
                    } else {
                        alert("–ù–ï–í–ï–†–ù–´–ô –ü–ê–†–û–õ–¨!");
                    }
                }
            }
        };
        xhr.send();
    }

    function saveAccount(u, p) {
        var xhr = new XMLHttpRequest();
        xhr.open("PUT", dbUrl + "profiles/" + u + ".json", true);
        xhr.send(JSON.stringify({ pw: p, about: "–ù–æ–≤–∏—á–æ–∫", hobby: "-" }));
        alert("–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω!");
        startChat(u, p);
    }

    function startChat(u, p) {
        currentUser = u;
        currentPass = p;
        document.getElementById('login-zone').style.display = 'none';
        document.getElementById('chat-zone').style.display = 'block';
        document.getElementById('my-name').innerText = u;
        load();
        setInterval(load, 15000);
    }

    // 2. –ó–ê–ì–†–£–ó–ö–ê –ò –§–ò–õ–¨–¢–† –õ–°
    function load() {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", dbUrl + "messages.json?nocache=" + Math.random(), true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4 && xhr.status == 200) {
                var data = JSON.parse(xhr.responseText);
                var box = document.getElementById('box');
                box.innerHTML = "";
                for (var id in data) {
                    var m = data[id];
                    
                    // –§–ò–õ–¨–¢–† –õ–°: –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä—É –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—é
                    if (m.to && m.to !== currentUser && m.u !== currentUser) continue;

                    var isPriv = m.to ? " priv" : "";
                    var t = m.t ? '<span class="time">['+m.t+']</span> ' : "";
                    var sender = '<span class="u">' + m.u + ':</span> ';
                    
                    box.innerHTML += '<div class="msg'+isPriv+'">' + t + sender + m.m + '</div>';
                }
                box.scrollTop = box.scrollHeight;
            }
        };
        xhr.send();
    }

    // 3. –û–¢–ü–†–ê–í–ö–ê (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π /w)
    function send() {
        var m = document.getElementById('msg').value;
        if (!m) return;

        var toUser = null;
        var msgText = m;

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ /w –ù–∏–∫ –°–æ–æ–±—â–µ–Ω–∏–µ
        if (m.indexOf('/w ') === 0) {
            var parts = m.split(' ');
            if (parts.length < 3) { alert("–§–æ—Ä–º–∞—Ç: /w –ù–∏–∫ –¢–µ–∫—Å—Ç"); return; }
            toUser = parts[1];
            msgText = "<b>[–õ–° –¥–ª—è " + toUser + "]:</b> " + parts.slice(2).join(' ');
        }

        var d = new Date();
        var time = (d.getHours()<10?'0':'')+d.getHours()+":"+(d.getMinutes()<10?'0':'')+d.getMinutes();

        var xhr = new XMLHttpRequest();
        xhr.open("POST", dbUrl + "messages.json", true);
        xhr.send(JSON.stringify({ u: currentUser, m: msgText, t: time, to: toUser }));
        document.getElementById('msg').value = "";
        setTimeout(load, 500);
    }
</script>
</body>
</html>
