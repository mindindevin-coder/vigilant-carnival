<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLUB_2000_LEGACY</title>
    <style>
        body { background: #008080; font-family: "Tahoma", "Arial", sans-serif; margin: 0; padding: 2px; font-size: 14px; }
        .win { background: #c0c0c0; border: 2px solid; border-color: #fff #808080 #808080 #fff; width: 98%; max-width: 400px; margin: 0 auto; }
        .title { background: #000080; color: #fff; padding: 3px 5px; font-weight: bold; font-size: 12px; }
        #box { background: #fff; height: 250px; overflow-y: scroll; border: 2px inset #fff; margin: 5px; padding: 5px; }
        .msg { border-bottom: 1px dotted #808080; margin-bottom: 4px; padding: 2px; word-wrap: break-word; color: #000; }
        .priv { background: #ffe0ff; border-left: 3px solid #800080; }
        .u { color: #0000ff; font-weight: bold; text-decoration: underline; }
        .input-bar { background: #c0c0c0; padding: 5px; border-top: 1px solid #808080; }
        input { font-size: 14px; border: 2px inset #fff; background: #fff; margin-bottom: 2px; }
        .btn { background: #c0c0c0; border: 2px solid; border-color: #fff #808080 #808080 #fff; padding: 4px 10px; font-weight: bold; }
    </style>
</head>
<body>

<div id="auth-win" class="win">
    <div class="title">LOGIN / ВХОД</div>
    <div style="padding:10px; text-align:center;">
        НИК:<br><input type="text" id="user" style="width:140px"><br>
        ПАСС:<br><input type="password" id="pass" style="width:140px"><br><br>
        <button class="btn" onclick="login()">ENTER</button>
    </div>
</div>

<div id="chat-win" class="win" style="display:none;">
    <div class="title">КЛУБ_2000.exe <span id="my-nick-display"></span></div>
    <div id="box"></div>
    <div class="input-bar">
        <input type="text" id="msg" style="width:65%" placeholder="Текст...">
        <button class="btn" onclick="send()">OK</button>
        <div style="margin-top:5px;">
            <button class="btn" style="font-size:10px;" onclick="tellUncleStory()">[ПО-ПО]</button>
            <button class="btn" style="font-size:10px;" onclick="load()">REFRESH</button>
        </div>
    </div>
</div>

<script>
    // Твоя ссылка Firebase
    var dbUrl = "https://ple7-edit-v1-default-rtdb.europe-west1.firebasedatabase.app/";
    var myNick = "";
    var isAdmin = false;
    var adminPass = "topsecret"; // Оставь здесь или поменяй, в базе проверь вручную

    // Функция AJAX для старых браузеров (Opera Mini / IE Mobile)
    function api(path, method, data, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open(method, dbUrl + path + ".json", true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4) {
                var res = null;
                try { res = JSON.parse(xhr.responseText); } catch(e) {}
                if (callback) callback(res);
            }
        };
        xhr.send(data ? JSON.stringify(data) : null);
    }

    function login() {
        var u = document.getElementById('user').value.trim();
        var p = document.getElementById('pass').value.trim();
        if(!u || !p) return;

        api("profiles/" + u, "GET", null, function(data) {
            if(data && data.pw !== p) { alert("WRONG PASS!"); return; }
            if(!data) { api("profiles/" + u, "PUT", {pw:p}); }
            
            myNick = u;
            if(myNick === "Admin") isAdmin = true; // Пароль проверит сама база при входе
            
            document.getElementById('auth-win').style.display = 'none';
            document.getElementById('chat-win').style.display = 'block';
            document.getElementById('my-nick-display').innerText = "(" + myNick + ")";
            load();
            setInterval(load, 15000); // Обновление раз в 15 сек для экономии трафика
        });
    }

    function load() {
        api("messages", "GET", null, function(data) {
            var box = document.getElementById('box');
            var content = "";
            for (var id in data) {
                var m = data[id];
                if (m.to && m.to !== myNick && m.u !== myNick) continue;
                
                var isPriv = m.to ? " priv" : "";
                var del = isAdmin ? ' <b style="color:red;cursor:pointer" onclick="delMsg(\''+id+'\')">[X]</b>' : '';
                
                content += '<div class="msg'+isPriv+'">' +
                    '<b class="u" onclick="toNick(\''+m.u+'\')">' + m.u + ':</b> ' + 
                    '<span>' + m.m + '</span>' + del + '</div>';
            }
            box.innerHTML = content;
            box.scrollTop = box.scrollHeight;
        });
    }

    function send() {
        var txt = document.getElementById('msg').value;
        if(!txt) return;

        var toUser = null;
        if(txt.indexOf('/w ') === 0) {
            var p = txt.split(' ');
            toUser = p[1];
            txt = "[PM]: " + p.slice(2).join(' ');
        }

        api("messages", "POST", { u: myNick, m: txt, to: toUser }, function() {
            document.getElementById('msg').value = "";
            load();
        });
    }

    function delMsg(id) {
        if(confirm("DELETE?")) {
            api("messages/" + id, "DELETE", null, function() { load(); });
        }
    }

    function toNick(n) {
        var i = document.getElementById('msg');
        i.value = n + ", " + i.value;
        i.focus();
    }

    function tellUncleStory() {
        var lines = [
            "Когда я был маленький, у меня был дядя...",
            "Он дарил мне дорогие игрушки.",
            "Прохожие говорили: 'Мальчик, люби дядю!'",
            "Я убил его. Чтобы говорили: 'Мальчик, люби СЕБЯ!'",
            "Я убил... Но мне стало стыдно."
        ];
        var i = 0;
        var timer = setInterval(function() {
            if(i < lines.length) {
                api("messages", "POST", { u: "ПО-ПО", m: lines[i] });
                i++;
            } else { clearInterval(timer); }
        }, 3000);
    }
</script>
</body>
</html>
