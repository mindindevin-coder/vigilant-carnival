<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLUB_2000_PRO</title>
    <style>
        body { background: #008080; font-family: "Tahoma", sans-serif; margin: 0; padding: 5px; font-size: 12px; }
        .win { background: #c0c0c0; border: 2px solid; border-color: #fff #808080 #808080 #fff; width: 100%; max-width: 400px; margin: 0 auto; }
        .title { background: linear-gradient(to right, #000080, #1084d0); color: #fff; padding: 3px 5px; font-weight: bold; display: flex; justify-content: space-between; }
        #box { background: #fff; height: 300px; overflow-y: scroll; border: 2px inset #fff; margin: 5px; padding: 5px; }
        .msg { border-bottom: 1px dotted #808080; margin-bottom: 5px; padding: 2px; word-wrap: break-word; }
        .priv { background: #ffe0ff; border-left: 3px solid #800080; }
        .u { color: #0000ff; font-weight: bold; cursor: pointer; }
        .sys { color: #800000; font-style: italic; }
        .admin-del { color: red; cursor: pointer; font-weight: bold; margin-left: 5px; [display:none]; }
        .input-bar { background: #c0c0c0; padding: 5px; border-top: 1px solid #808080; }
        input { font-size: 12px; border: 2px inset #fff; padding: 2px; background: #fff; }
        .btn { background: #c0c0c0; border: 2px solid; border-color: #fff #808080 #808080 #fff; cursor: pointer; padding: 2px 5px; }
        .btn:active { border-color: #808080 #fff #fff #808080; }
    </style>
</head>
<body>

<div id="auth-win" class="win">
    <div class="title">ВХОД В СИСТЕМУ</div>
    <div style="padding:15px; text-align:center;">
        НИК: <input type="text" id="user" style="width:100px"><br>
        ПАСС: <input type="password" id="pass" style="width:100px"><br><br>
        <button class="btn" onclick="login()">CONNECT</button>
    </div>
</div>

<div id="chat-win" class="win" style="display:none;">
    <div class="title">
        <span>КЛУБ_2000.exe</span>
        <span id="my-nick-display" style="font-size:10px; opacity:0.8;"></span>
    </div>
    <div id="box"></div>
    <div class="input-bar">
        <input type="text" id="msg" style="width:70%" placeholder="Сообщение...">
        <button class="btn" onclick="send()">OK</button>
        <div style="margin-top:5px; font-size:10px;">
            Команды: /w ник текст (ЛС), /uncle (Гришковец)
        </div>
    </div>
</div>

<script>
    var dbUrl = "https://ple7-edit-v1-default-rtdb.europe-west1.firebasedatabase.app/";
    var myNick = "";
    var isAdmin = false;
    var adminPass = "topsecret"; // Твой секретный пароль админа

    function login() {
        var u = document.getElementById('user').value.trim();
        var p = document.getElementById('pass').value.trim();
        if(!u || !p) return;

        fetch(dbUrl + "profiles/" + u + ".json").then(r => r.json()).then(data => {
            if(data && data.pw !== p) { alert("ОШИБКА ДОСТУПА"); return; }
            if(!data) fetch(dbUrl + "profiles/" + u + ".json", {method:'PUT', body: JSON.stringify({pw:p})});
            
            myNick = u;
            if(myNick === "Admin" && p === adminPass) isAdmin = true;
            
            document.getElementById('auth-win').style.display = 'none';
            document.getElementById('chat-win').style.display = 'block';
            document.getElementById('my-nick-display').innerText = "[" + myNick + "]";
            load();
            setInterval(load, 10000);
        });
    }

    function load() {
        fetch(dbUrl + "messages.json").then(r => r.json()).then(data => {
            var box = document.getElementById('box');
            box.innerHTML = "";
            for (var id in data) {
                var m = data[id];
                // Фильтр ЛС
                if (m.to && m.to !== myNick && m.u !== myNick) continue;

                var isPriv = m.to ? " priv" : "";
                var delBtn = isAdmin ? ' <span class="admin-del" onclick="delMsg(\''+id+'\')">[X]</span>' : '';
                
                box.innerHTML += '<div class="msg'+isPriv+'">' +
                    '<span class="u" onclick="toNick(\''+m.u+'\')">' + m.u + ':</span> ' + 
                    '<span>' + m.m + '</span>' + delBtn + '</div>';
            }
            box.scrollTop = box.scrollHeight;
        });
    }

    function send() {
        var txt = document.getElementById('msg').value;
        if(!txt) return;

        if(txt === "/uncle") { tellUncleStory(); document.getElementById('msg').value = ""; return; }

        var toUser = null;
        if(txt.indexOf('/w ') === 0) {
            var p = txt.split(' ');
            toUser = p[1];
            txt = "<i>[ЛС]: " + p.slice(2).join(' ') + "</i>";
        }

        fetch(dbUrl + "messages.json", {
            method: 'POST',
            body: JSON.stringify({ u: myNick, m: txt, to: toUser })
        }).then(() => {
            document.getElementById('msg').value = "";
            load();
        });
    }

    function delMsg(id) {
        if(confirm("Удалить сообщение?")) {
            fetch(dbUrl + "messages/" + id + ".json", { method: 'DELETE' }).then(() => load());
        }
    }

    function toNick(n) {
        document.getElementById('msg').value = n + ", " + document.getElementById('msg').value;
        document.getElementById('msg').focus();
    }

    function tellUncleStory() {
        var lines = [
            "Когда я был маленький, у меня был дядя...",
            "Он дарил мне дорогие игрушки.",
            "Прохожие говорили: 'Мальчик, люби дядю!'",
            "И я решил его убить. Чтобы говорили: 'Мальчик, люби СЕБЯ!'",
            "Я убил... Никто не понял... Но мне стало стыдно."
        ];
        lines.forEach((l, i) => {
            setTimeout(() => {
                fetch(dbUrl + "messages.json", {
                    method: 'POST',
                    body: JSON.stringify({ u: "ПО-ПО", m: "<b style='color:red'>" + l + "</b>" })
                }).then(() => load());
            }, i * 2500);
        });
    }
</script>
</body>
</html>
